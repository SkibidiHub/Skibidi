<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Email 10 ph√∫t ‚Äî Real (mail.tm)</title>
  <meta name="description" content="Temporary email 10 minutes using mail.tm API - no server needed" />
  <style>
    :root{--bg:#0b1220;--card:#07111a;--text:#e6eef8;--muted:#9fb6d0;--accent:#00c9ff;--glass:rgba(255,255,255,0.04)}
    *{box-sizing:border-box}
    html,body{height:100%;margin:0;font-family:Inter, 'Segoe UI', system-ui, Roboto, Helvetica, Arial;color:var(--text);background:linear-gradient(180deg,#071022 0%, #0b1220 100%)}
    .app{max-width:980px;margin:28px auto;padding:20px}
    .header{display:flex;align-items:center;justify-content:space-between;gap:12px}
    h1{margin:0;font-size:20px}
    .card{background:var(--card);padding:18px;border-radius:12px;box-shadow:0 10px 30px rgba(2,6,23,0.6)}
    .row{display:flex;gap:12px;align-items:center}
    .email-box{padding:10px 12px;border-radius:10px;background:var(--glass);min-width:280px;word-break:break-all}
    .controls{display:flex;gap:8px;align-items:center}
    button{background:var(--accent);color:#000;border:none;padding:8px 12px;border-radius:10px;cursor:pointer;font-weight:700}
    .ghost{background:transparent;color:var(--text);border:1px solid rgba(255,255,255,0.06)}
    .muted{color:var(--muted);font-size:13px}
    .inbox{margin-top:16px}
    .message{background:#071822;padding:12px;border-radius:10px;margin-bottom:10px;display:flex;justify-content:space-between;gap:12px}
    .message .meta{flex:1}
    .badge{font-size:12px;padding:6px 8px;border-radius:10px;background:rgba(255,255,255,0.03)}
    .timer{font-weight:800}
    /* modal */
    .modal-backdrop{position:fixed;inset:0;background:rgba(2,6,23,0.6);display:none;align-items:center;justify-content:center}
    .modal{background:var(--card);max-width:800px;width:94%;padding:18px;border-radius:12px}
    .modal h3{margin:0 0 8px}
    .modal .body{max-height:60vh;overflow:auto;padding-top:8px;color:var(--muted)}
    .top-right{display:flex;gap:8px;align-items:center}
    /* dark/light switch */
    .switch{display:inline-flex;align-items:center;gap:8px}
    .small{padding:6px 8px;font-size:13px}
    .error{background:#3a0b0b;color:#ffd6d6;padding:10px;border-radius:8px}
    /* responsive */
    @media (max-width:640px){.row{flex-direction:column;align-items:stretch}.email-box{width:100%}}
  </style>
</head>
<body>
  <div class="app card">
    <div class="header">
      <div>
        <h1>üìß Email 10 ph√∫t (real) ‚Äî mail.tm</h1>
        <div class="muted">T·∫°o email t·∫°m th·ªùi, nh·∫≠n mail th·∫≠t ‚Äî kh√¥ng c·∫ßn host</div>
      </div>
      <div class="top-right">
        <div class="switch muted">Theme: <button id="themeBtn" class="ghost small">Dark</button></div>
      </div>
    </div>

    <div style="margin-top:14px" class="row">
      <div class="email-box" id="email">ƒêang t·∫°o...</div>
      <div style="display:flex;flex-direction:column;align-items:flex-end;gap:8px">
        <div class="controls">
          <button id="newBtn">üîÑ T·∫°o email m·ªõi</button>
          <button id="copyBtn" class="ghost small">üìã Sao ch√©p</button>
          <button id="refreshBtn" class="ghost small">üîÅ L√†m m·ªõi</button>
        </div>
        <div class="controls">
          <div class="muted">Th·ªùi gian s·ªëng: <span id="timer" class="timer">--:--</span></div>
        </div>
        <div id="status" style="width:100%;text-align:right"></div>
      </div>
    </div>

    <h2 style="margin-top:18px">üì• H·ªôp th∆∞ ƒë·∫øn</h2>
    <div id="inbox" class="inbox muted">ƒêang ch·ªù...</div>

    <div style="margin-top:12px" class="muted">Ghi ch√∫: mail.tm l√† d·ªãch v·ª• mi·ªÖn ph√≠ c√≥ CORS ‚Äî web n√†y t·∫°o t√†i kho·∫£n real v√† l·∫•y token ƒë·ªÉ ƒë·ªçc message. Email t·ªìn t·∫°i cho ƒë·∫øn khi mail.tm xo√° theo ch√≠nh s√°ch c·ªßa h·ªç (ch√∫ng ta hi·ªÉn th·ªã countdown 10 ph√∫t cho UX).</div>
  </div>

  <!-- modal -->
  <div id="backdrop" class="modal-backdrop">
    <div class="modal card">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <h3 id="modalSubject">Ti√™u ƒë·ªÅ</h3>
        <div style="display:flex;gap:8px;align-items:center">
          <div class="muted" id="modalFrom">T·ª´: ...</div>
          <button id="closeModal" class="ghost small">ƒê√≥ng</button>
        </div>
      </div>
      <div class="body" id="modalBody"></div>
    </div>
  </div>

  <script>
    // ================= CONFIG =================
    // Polling interval (ms)
    const POLL_MS = 10_000; // 10s to reduce API usage
    const LIFETIME_MS = 10 * 60 * 1000; // 10 minutes UI countdown

    // mail.tm endpoints
    const API_ROOT = 'https://api.mail.tm';

    // STATE
    let account = null; // {id,address,password}
    let token = null; // bearer token
    let expiresAt = null;
    let pollIntervalId = null;

    // UI refs
    const emailEl = document.getElementById('email');
    const inboxEl = document.getElementById('inbox');
    const statusEl = document.getElementById('status');
    const timerEl = document.getElementById('timer');
    const newBtn = document.getElementById('newBtn');
    const copyBtn = document.getElementById('copyBtn');
    const refreshBtn = document.getElementById('refreshBtn');
    const themeBtn = document.getElementById('themeBtn');

    const backdrop = document.getElementById('backdrop');
    const modalSubject = document.getElementById('modalSubject');
    const modalFrom = document.getElementById('modalFrom');
    const modalBody = document.getElementById('modalBody');
    const closeModal = document.getElementById('closeModal');

    // UTIL
    function showStatus(msg, isErr=false){
      statusEl.innerHTML = isErr ? `<div class=error>${msg}</div>` : `<div class=muted>${msg}</div>`;
    }

    function randString(n=8){
      const chars = 'abcdefghijklmnopqrstuvwxyz0123456789';
      let s=''; for(let i=0;i<n;i++) s += chars[Math.floor(Math.random()*chars.length)];
      return s;
    }

    function secondsToMMSS(s){
      const m = Math.floor(s/60).toString().padStart(2,'0');
      const sec = (s%60).toString().padStart(2,'0');
      return `${m}:${sec}`;
    }

    // THEME
    (function loadTheme(){
      const t = localStorage.getItem('theme') || 'dark';
      if(t === 'light') document.documentElement.style.background = '#f6f8fa';
      themeBtn.innerText = t === 'dark' ? 'Dark' : 'Light';
      localStorage.setItem('theme', t);
    })();
    themeBtn.addEventListener('click', ()=>{
      const cur = localStorage.getItem('theme') || 'dark';
      const next = cur === 'dark' ? 'light' : 'dark';
      if(next === 'light') document.documentElement.style.background = '#f6f8fa'; else document.documentElement.style.background = 'linear-gradient(180deg,#071022 0%, #0b1220 100%)';
      themeBtn.innerText = next === 'dark' ? 'Dark' : 'Light';
      localStorage.setItem('theme', next);
    });

    // ================= mail.tm helpers =================
    async function api(path, opts={}){
      const url = API_ROOT + path;
      const headers = opts.headers || {};
      if(token) headers['Authorization'] = `Bearer ${token}`;
      headers['Accept'] = 'application/ld+json';
      try{
        const res = await fetch(url, {...opts, headers});
        if(!res.ok) throw new Error('HTTP ' + res.status + ' ' + res.statusText);
        const contentType = res.headers.get('content-type') || '';
        if(contentType.includes('application/json') || contentType.includes('application/ld+json')) return await res.json();
        return await res.text();
      }catch(e){
        throw e;
      }
    }

    // Create account: pick a domain from /domains and POST /accounts
    async function createAccount(){
      showStatus('T·∫°o t√†i kho·∫£n...');
      try{
        const domainsRes = await api('/domains');
        const domains = Array.isArray(domainsRes['hydra:member']) ? domainsRes['hydra:member'] : (domainsRes['hydra:member'] || []);
        // fallback parse
        let domainList = [];
        if(Array.isArray(domainsRes['hydra:member'])) domainList = domainsRes['hydra:member'].map(d=>d.domain);
        if(domainList.length === 0 && Array.isArray(domainsRes)) domainList = domainsRes.map(d=>d.domain);
        if(domainList.length === 0) domainList = ['mail.tm'];
        const domain = domainList[Math.floor(Math.random()*domainList.length)];
        const username = randString(10);
        const address = username + '@' + domain;
        const password = randString(12) + 'A1!';

        const body = {address, password};
        // create account
        await api('/accounts', {method:'POST', body:JSON.stringify(body), headers: {'Content-Type':'application/json'}});
        // get token
        const tokenRes = await api('/token', {method:'POST', body:JSON.stringify({address,password}), headers:{'Content-Type':'application/json'}});
        token = tokenRes.token;
        account = {address,password};
        showStatus('T·∫°o t√†i kho·∫£n th√†nh c√¥ng.');
        return account;
      }catch(e){
        // If account exists or API returns 400, try to create a local-only address and continue without token (read-only impossible)
        console.warn('createAccount error', e);
        throw e;
      }
    }

    async function fetchMessages(){
      if(!token) return [];
      try{
        const res = await api('/messages');
        // messages list in hydra:member or direct array
        const msgs = Array.isArray(res['hydra:member']) ? res['hydra:member'] : (Array.isArray(res) ? res : []);
        return msgs;
      }catch(e){
        console.warn('fetchMessages failed', e);
        throw e;
      }
    }

    async function fetchMessage(id){
      if(!token) throw new Error('No token');
      return await api(`/messages/${id}`);
    }

    // ================= UI actions =================
    async function startNewEmail(){
      // cleanup
      clearInterval(pollIntervalId);
      token = null; account = null;
      emailEl.innerText = 'ƒêang t·∫°o...';
      inboxEl.innerHTML = '<div class="muted">ƒêang ch·ªù...</div>';

      try{
        await createAccount();
      }catch(e){
        showStatus('Kh√¥ng th·ªÉ t·∫°o account qua mail.tm: ' + e.message, true);
        // fallback: generate local-only address for UX, but messages won't work
        const fallback = randString(10) + '@mail.tm';
        account = {address: fallback, password: null};
        emailEl.innerText = account.address;
        expiresAt = Date.now() + LIFETIME_MS;
        startTimer();
        inboxEl.innerHTML = '<div class="muted">Kh√¥ng th·ªÉ k·∫øt n·ªëi t·ªõi mail.tm. Ki·ªÉm tra m·∫°ng ho·∫∑c th·ª≠ l·∫°i.</div>';
        return;
      }

      // set UI
      emailEl.innerText = account.address;
      expiresAt = Date.now() + LIFETIME_MS;
      startTimer();
      // start polling
      await refreshInbox();
      pollIntervalId = setInterval(refreshInbox, POLL_MS);
    }

    async function refreshInbox(){
      if(!token){ showStatus('Ch∆∞a c√≥ token ƒë·ªÉ ƒë·ªçc h·ªôp th∆∞.', true); return; }
      showStatus('ƒêang ki·ªÉm tra h·ªôp th∆∞...');
      try{
        const msgs = await fetchMessages();
        if(!msgs || msgs.length === 0){
          inboxEl.innerHTML = '<div class="muted">Ch∆∞a c√≥ email n√†o...</div>';
          showStatus('Kh√¥ng c√≥ email m·ªõi.');
          return;
        }
        // render list (batch update innerHTML)
        const html = msgs.map(m=>{
          const subject = escapeHtml(m.subject || '(Kh√¥ng c√≥ ti√™u ƒë·ªÅ)');
          const from = escapeHtml((m.from && m.from.address) || m.from || '(Kh√¥ng r√µ)');
          const id = m.id;
          const created = new Date(m.createdAt).toLocaleString();
          return `<div class="message"><div class="meta"><div style="font-weight:700">${subject}</div><div class="muted">${from} ‚Ä¢ ${created}</div></div><div style="display:flex;gap:8px;align-items:center"><button class="ghost small" onclick="openMessage('${id}')">üì© Xem</button></div></div>`;
        }).join('');
        inboxEl.innerHTML = html;
        showStatus('ƒê√£ t·∫£i ' + msgs.length + ' email.');
      }catch(e){
        showStatus('L·ªói khi l·∫•y h·ªôp th∆∞: ' + e.message, true);
      }
    }

    async function openMessage(id){
      try{
        const msg = await fetchMessage(id);
        modalSubject.innerText = msg.subject || '(Kh√¥ng c√≥ ti√™u ƒë·ªÅ)';
        modalFrom.innerText = 'T·ª´: ' + ((msg.from && msg.from.address) || msg.from || 'Kh√¥ng r√µ');
        // msg has text and html body fields
        const body = msg.html || msg.text || '(Kh√¥ng c√≥ n·ªôi dung)';
        // show html safely if available ‚Äî mail.tm returns HTML string we can inject (it's external content) ‚Äî to be safe, we put it into modalBody as text if no html
        if(msg.html){
          modalBody.innerHTML = msg.html;
        } else {
          modalBody.innerText = msg.text || '(Kh√¥ng c√≥ n·ªôi dung)';
        }
        backdrop.style.display = 'flex';
      }catch(e){
        showStatus('Kh√¥ng th·ªÉ ƒë·ªçc email: ' + e.message, true);
      }
    }

    // expose openMessage to window for inline onclick
    window.openMessage = openMessage;

    // timer
    let timerId = null;
    function startTimer(){
      clearInterval(timerId);
      timerId = setInterval(()=>{
        const diff = Math.max(0, Math.round((expiresAt - Date.now())/1000));
        timerEl.innerText = secondsToMMSS(diff);
        if(diff <= 0){
          clearInterval(timerId);
          showStatus('H·∫øt th·ªùi gian 10 ph√∫t. T·∫°o email m·ªõi n·∫øu c·∫ßn.');
        }
      }, 500);
    }

    // small helpers
    function escapeHtml(s){
      if(!s) return '';
      return s.replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":"&#39;"})[c]);
    }

    // UI events
    newBtn.addEventListener('click', ()=>{ startNewEmail(); });
    refreshBtn.addEventListener('click', ()=>{ refreshInbox(); });
    copyBtn.addEventListener('click', ()=>{
      const txt = account && account.address ? account.address : '';
      if(!txt) return showStatus('Ch∆∞a c√≥ ƒë·ªãa ch·ªâ ƒë·ªÉ sao ch√©p.', true);
      navigator.clipboard?.writeText(txt).then(()=> showStatus('ƒê√£ sao ch√©p ƒë·ªãa ch·ªâ')).catch(()=> showStatus('Kh√¥ng th·ªÉ sao ch√©p (y√™u c·∫ßu HTTPS).', true));
    });

    closeModal.addEventListener('click', ()=>{ backdrop.style.display = 'none'; modalBody.innerHTML = ''; });
    backdrop.addEventListener('click', (e)=>{ if(e.target === backdrop) { backdrop.style.display = 'none'; modalBody.innerHTML = ''; } });

    // init
    (async function(){
      try{
        await startNewEmail();
      }catch(e){
        console.error(e);
        showStatus('L·ªói kh·ªüi t·∫°o: ' + e.message, true);
      }
    })();

  </script>
</body>
</html>
